<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel de Automação</title>
    <style>
        body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,sans-serif;display:flex;justify-content:center;padding:2rem 0;background-color:#f0f2f5;color:#333}
        .container{background-color:white;padding:2rem;border-radius:8px;box-shadow:0 4px 12px rgba(0,0,0,.1);width:100%;max-width:500px}
        h1,h2{text-align:center;color:#1c1e21}
        h2{margin-top:2rem;padding-top:2rem;border-top:1px solid #dddfe2}
        label{display:block;margin-bottom:.5rem;font-weight:600}
        input{width:100%;padding:.75rem;border:1px solid #dddfe2;border-radius:6px;font-size:1rem;box-sizing:border-box}
        button{width:100%;padding:.75rem;border:none;border-radius:6px;background-color:#007bff;color:white;font-size:1rem;font-weight:bold;cursor:pointer;margin-top:1rem;transition:background-color .2s}
        button:hover:not(:disabled){background-color:#0056b3}
        button:disabled{background-color:#a0c7ff;cursor:not-allowed}
        #logged-in-section, #otp-step{display:none}
        .message{margin-top:1rem;padding:.75rem;border-radius:6px;font-weight:500;text-align:center}
        .message-success{background-color:#d4edda;color:#155724}
        .message-error{background-color:#f8d7da;color:#721c24}
        #automation-log, .error-details{width:100%;background-color:#222;color:#eee;font-family:monospace;font-size:.8rem;border:1px solid #444;border-radius:6px;margin-top:1rem;padding:10px;box-sizing:border-box;overflow-y:auto;white-space:pre-wrap}
        #automation-log{height:200px;color:#0f0;}
    </style>
</head>
<body>
    <div class="container">
        <h1>Painel de Automação</h1>
        <div id="login-section">
            <div id="phone-step"><label for="phone">Telefone (com DDD)</label><input type="tel" id="phone" placeholder="11987654321"><button id="requestCodeBtn">Enviar Código</button></div>
            <div id="otp-step"><label for="otp">Código SMS</label><input type="text" id="otp" placeholder="Digite o código"><button id="verifyCodeBtn">Fazer Login</button></div>
            <div id="loginMessage" class="message" style="display:none;"></div>
        </div>
        <div id="logged-in-section">
            <h2>Tarefas</h2>
            <button id="getTasksBtn">1. Buscar Tarefas Disponíveis</button>
            <button id="completeAllTasksBtn" disabled>2. Concluir Todas as Tarefas</button>
            <div id="taskMessage" class="message" style="display:none;"></div>
            <h3>Log de Automação:</h3>
            <div id="automation-log">Aguardando ações...</div>
        </div>
    </div>

    <script>
        let authorizationToken = null;
        let availableTasks = [];
        const ui = {
            loginSection: document.getElementById('login-section'), loggedInSection: document.getElementById('logged-in-section'), phoneStep: document.getElementById('phone-step'), otpStep: document.getElementById('otp-step'), loginMessage: document.getElementById('loginMessage'), taskMessage: document.getElementById('taskMessage'), automationLog: document.getElementById('automation-log'), getTasksBtn: document.getElementById('getTasksBtn'), completeAllTasksBtn: document.getElementById('completeAllTasksBtn'), phoneInput: document.getElementById('phone'), otpInput: document.getElementById('otp'), requestCodeBtn: document.getElementById('requestCodeBtn'), verifyCodeBtn: document.getElementById('verifyCodeBtn')
        };
        const showMessage = (el, text, type, details) => {
            let detailsHtml = '';
            if (details) {
                detailsHtml = `<pre class="error-details">${JSON.stringify(details, null, 2)}</pre>`;
            }
            el.innerHTML = text + detailsHtml;
            el.className = `message message-${type}`;
            el.style.display = 'block';
        };
        const log = (text) => { ui.automationLog.innerHTML += `${text}\n`; ui.automationLog.scrollTop = ui.automationLog.scrollHeight; };
        const showLoggedInState = () => { ui.loginSection.style.display = 'none'; ui.loggedInSection.style.display = 'block'; log('Login bem-sucedido. Pronto para buscar tarefas.'); };
        const fetchApi = async (endpoint, body) => {
            const response = await fetch(endpoint, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(body) });
            const data = await response.json();
            if (!response.ok) throw data; // Lança o objeto de erro inteiro
            return data;
        };
        document.addEventListener('DOMContentLoaded', () => { const savedToken = localStorage.getItem('authToken'); if (savedToken) { authorizationToken = savedToken; showLoggedInState(); } });
        ui.requestCodeBtn.addEventListener('click', async () => {
            const phoneNumber = ui.phoneInput.value; if (!phoneNumber) return showMessage(ui.loginMessage, 'Insira o telefone.', 'error'); ui.requestCodeBtn.disabled = true;
            try { await fetchApi('/api/request-code', { phoneNumber }); showMessage(ui.loginMessage, 'Código enviado.', 'success'); ui.phoneStep.style.display = 'none'; ui.otpStep.style.display = 'block'; } 
            catch (e) { showMessage(ui.loginMessage, e.message, 'error', e.details); } finally { ui.requestCodeBtn.disabled = false; }
        });
        ui.verifyCodeBtn.addEventListener('click', async () => {
            const phoneNumber = ui.phoneInput.value; const otpCode = ui.otpInput.value; if (!otpCode) return showMessage(ui.loginMessage, 'Insira o código.', 'error'); ui.verifyCodeBtn.disabled = true;
            try { const data = await fetchApi('/api/verify-code', { phoneNumber, otpCode }); authorizationToken = data.authorizationToken; localStorage.setItem('authToken', authorizationToken); showLoggedInState(); } 
            catch (e) { showMessage(ui.loginMessage, e.message, 'error', e.details); } finally { ui.verifyCodeBtn.disabled = false; }
        });
        ui.getTasksBtn.addEventListener('click', async () => {
            if (!authorizationToken) return log('ERRO: Token não encontrado. Faça login.'); ui.getTasksBtn.disabled = true; log('Buscando tarefas...');
            try {
                const data = await fetch('/api/get-tasks', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ authorizationToken }) }).then(res => res.json());
                availableTasks = data?.data?.offerWallList?.[0]?.campaignList || [];
                if (availableTasks.length > 0) { log(`${availableTasks.length} tarefas encontradas.`); ui.completeAllTasksBtn.disabled = false; } 
                else { log('Nenhuma tarefa encontrada. Resposta completa:'); log(JSON.stringify(data, null, 2)); }
            } catch (e) { log(`ERRO ao buscar tarefas: ${e}`); } finally { ui.getTasksBtn.disabled = false; }
        });
        ui.completeAllTasksBtn.addEventListener('click', async () => {
            if (availableTasks.length === 0) return log('Nenhuma tarefa para concluir.'); ui.completeAllTasksBtn.disabled = true; ui.getTasksBtn.disabled = true;
            log(`--- Iniciando conclusão de ${availableTasks.length} tarefas ---`);
            for (const task of availableTasks) {
                const campaignId = task.id; if (!campaignId) continue; log(`> Concluindo tarefa ID: ${campaignId.substring(0, 8)}...`);
                try { const data = await fetchApi('/api/complete-task', { authorizationToken, campaignId }); log(`  ... Sucesso!`); }
                catch (e) { log(`  ... ERRO: ${e.message}`); }
                await new Promise(r => setTimeout(r, 1000));
            }
            log('--- Conclusão de todas as tarefas finalizada. ---'); ui.getTasksBtn.disabled = false;
        });
    </script>
</body>
</html>
